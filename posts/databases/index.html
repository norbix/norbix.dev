<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><script>(function(){const e=localStorage.getItem("theme"),t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;e==="dark"||!e&&t?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),window.setTheme=function(e){localStorage.setItem("theme",e),document.documentElement.classList.toggle("dark",e==="dark")}})()</script><title>Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization | norbix.dev
</title><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization | norbix.dev - The log of my journey through code & software systems architecture</title>
<meta name=keywords content="databases,sql,nosql,btrees,acid,normalization"><meta name=description content="Learn the key database concepts every software engineer should know: B-Trees, SQL, NoSQL, ACID properties, and database normalization principles."><meta name=author content><link rel=canonical href=https://norbix.dev/posts/databases/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://norbix.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://norbix.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://norbix.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://norbix.dev/apple-touch-icon.png><link rel=mask-icon href=https://norbix.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://norbix.dev/posts/databases/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=canonical href=https://norbix.dev/posts/databases/><meta property="og:title" content="Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization"><meta property="og:url" content="https://norbix.dev/posts/databases/"><meta property="og:image" content="https://norbix.dev/banner.jpg"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization"><meta name=twitter:image content="https://norbix.dev/banner.jpg"><script data-goatcounter=https://norbix.goatcounter.com/count async src=//gc.zgo.at/count.js></script><link rel=alternate type=application/rss+xml title="RSS Feed for norbix.dev" href=/index.xml><script src=https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js defer></script><script>document.addEventListener("DOMContentLoaded",function(){window.mermaid&&(document.querySelectorAll("code.language-mermaid").forEach(function(e){var n=e.parentElement,t=document.createElement("div");t.className="mermaid",t.textContent=e.textContent,n.replaceWith(t)}),mermaid.initialize({startOnLoad:!0}))})</script><meta property="og:title" content="Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization"><meta property="og:description" content="Learn the key database concepts every software engineer should know: B-Trees, SQL, NoSQL, ACID properties, and database normalization principles."><meta property="og:type" content="article"><meta property="og:url" content="https://norbix.dev/posts/databases/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-28T18:00:00+02:00"><meta property="article:modified_time" content="2025-04-28T18:00:00+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization"><meta name=twitter:description content="Learn the key database concepts every software engineer should know: B-Trees, SQL, NoSQL, ACID properties, and database normalization principles."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://norbix.dev/posts/"},{"@type":"ListItem","position":2,"name":"Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization","item":"https://norbix.dev/posts/databases/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization","name":"Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization","description":"Learn the key database concepts every software engineer should know: B-Trees, SQL, NoSQL, ACID properties, and database normalization principles.","keywords":["databases","sql","nosql","btrees","acid","normalization"],"articleBody":" ‚ÄúBad data ruins good applications. Good databases build great systems.‚Äù\nDatabases are the silent powerhouse behind most modern applications. Whether you‚Äôre building a simple blog, an enterprise CRM, or a distributed IoT system, understanding database fundamentals can dramatically improve the quality and scalability of your software.\nIn this article, I‚Äôll walk through essential database concepts every engineer should master: B-Trees, SQL, NoSQL, ACID properties, and normalization.\nüìö B-Trees: The Backbone of Indexing Efficient data retrieval is crucial, and that‚Äôs where B-Trees come in. B-Trees are balanced tree structures that allow fast search, insert, and delete operations in logarithmic time.\nIn databases like MySQL (InnoDB) and PostgreSQL, indexes are often implemented as B-Trees, making queries much faster by avoiding full table scans.\nüîπ Tip: Always index columns used in WHERE, JOIN, and ORDER BY clauses to leverage B-Tree advantages.\nüìÇ SQL: Structured Query Language SQL is the standard language for querying and manipulating relational databases.\nKey operations:\nSELECT: Retrieve data INSERT: Add new records UPDATE: Modify existing records DELETE: Remove records SQL enforces a strict schema and supports relationships, making it ideal for structured data.\nPopular SQL databases: PostgreSQL, MySQL, MariaDB, Microsoft SQL Server.\nüîπ Tip: Master JOIN operations and subqueries to unlock SQL‚Äôs full power.\nüî∞ PostgreSQL quick start (copy‚Äìpaste) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 -- One-time sandbox CREATE SCHEMA learnsql; SET search_path TO learnsql; CREATE TABLE authors ( author_id BIGSERIAL PRIMARY KEY, name TEXT NOT NULL, country TEXT NOT NULL ); CREATE TABLE books ( book_id BIGSERIAL PRIMARY KEY, author_id BIGINT NOT NULL REFERENCES authors(author_id), title TEXT NOT NULL, year INT, price_usd NUMERIC(6,2) CHECK (price_usd \u003e= 0) ); INSERT INTO authors (name, country) VALUES ('Alicja Kowalska','PL'), ('Bartosz Nowak','PL'), ('Chloe Schneider','DE'), ('Diego Garc√≠a','ES'); INSERT INTO books (author_id,title,year,price_usd) VALUES (1,'SQL for Starters',2023,29.99), (1,'Advanced SQL Patterns',2025,39.50), (2,'Data Modeling 101',2022,24.00), (2,'PostgreSQL Cookbook',2024,35.00), (3,'Window Functions in Practice',2024,32.00), (4,'Indexing and Performance',2021,27.50), (4,'JSON in Postgres',2025,31.00); Select \u0026 filter Select specific columns, filter with WHERE, sort with ORDER BY, and limit results with LIMIT.\n1 2 3 4 5 SELECT title, price_usd FROM books WHERE price_usd \u003e 30 ORDER BY price_usd DESC LIMIT 3; Joins Joins combine rows from two or more tables based on related columns.\nA SQL JOIN doesn‚Äôt permanently merge tables; it builds a wider result set at query time by pairing rows whose keys match your condition. Think of it as a lookup that produces a new, temporary table.\n1 2 3 4 5 -- All books with author info SELECT b.title, a.name AS author, a.country, b.year, b.price_usd FROM books b JOIN authors a ON a.author_id = b.author_id ORDER BY a.name, b.year; Aggregation Aggregate functions summarize data: COUNT(), SUM(), AVG(), MIN(), MAX().\n1 2 3 4 5 6 7 8 -- Avg price by country; only countries with ‚â•2 books SELECT a.country, -- 1) grouping key (country) ROUND(AVG(b.price_usd), 2) AS avg_price -- 2) average book price, 2 decimals FROM books b JOIN authors a ON a.author_id = b.author_id -- 3) attach each book to its author's country GROUP BY a.country -- 4) aggregate per country HAVING COUNT(*) \u003e= 2 -- 5) keep only countries with 2+ books ORDER BY avg_price DESC; -- 6) sort by avg price, highest first Hint: GROUP BY vs ORDER BY\nGROUP BY partitions rows into groups and reduces them (with aggregates like COUNT, AVG, SUM).\nORDER BY sorts the final rows (whatever they are‚Äîraw or aggregated).\nThey do different jobs and often appear together.\nUseful operators 1 2 3 4 5 6 7 8 9 10 11 12 -- Case-insensitive search SELECT title FROM books WHERE title ILIKE '%sql%'; -- Categorize with CASE SELECT title, CASE WHEN price_usd \u003e= 35 THEN 'premium' WHEN price_usd \u003e= 30 THEN 'mid' ELSE 'budget' END AS price_tier FROM books; -- Distinct values SELECT DISTINCT country FROM authors ORDER BY country; CTEs (WITH) \u0026 subqueries CTE (Common Table Expression) example:\n1 2 3 4 5 6 7 8 9 10 -- Authors whose average book price \u003e $30 WITH avg_price AS ( SELECT author_id, AVG(price_usd) AS avg_price FROM books GROUP BY author_id ) SELECT a.name, ap.avg_price FROM avg_price ap JOIN authors a ON a.author_id = ap.author_id WHERE ap.avg_price \u003e 30; Window functions (analytics without collapsing rows) Functions like ROW_NUMBER(), RANK(), SUM() OVER(), etc., operate over a set of rows related to the current row.\n1 2 3 4 5 6 -- Rank the most expensive book per author SELECT a.name, b.title, b.price_usd, RANK() OVER (PARTITION BY a.author_id ORDER BY b.price_usd DESC) AS rnk FROM books b JOIN authors a ON a.author_id = b.author_id ORDER BY a.name, rnk; Indexes \u0026 EXPLAIN (performance mindset) Indexes speed up lookups but slow down writes and take space. Use them wisely.\n1 2 3 CREATE INDEX idx_books_author_year ON books(author_id, year); EXPLAIN ANALYZE SELECT * FROM books WHERE author_id = 2 AND year \u003e= 2024 ORDER BY year; If you see a sequential scan on a large table, consider whether your index matches the filter and order columns (and their order).\nCommon pitfalls (Postgres) Strings use single quotes (‚ÄòPL‚Äô). Double quotes are identifiers.\nNULL logic: use IS NULL / IS NOT NULL; = NULL is never true.\nInteger division: 1/2 = 0. Cast for rates: sum(x)::numeric / nullif(count(*),0).\nAll non-aggregated SELECT columns must appear in GROUP BY.\nPrefer window functions for ‚Äútop-k per group‚Äù and ‚Äúrolling‚Äù metrics.\nüîÑ NoSQL: Flexibility at Scale NoSQL databases emerged to handle massive, unstructured, and rapidly changing data.\nTypes of NoSQL databases:\nDocument stores: MongoDB, Couchbase Key-value stores: Redis, DynamoDB Wide-column stores: Cassandra, HBase Graph databases: Neo4j, Amazon Neptune NoSQL systems often prioritize availability and partition tolerance (CAP theorem) over strict consistency.\nüîπ Tip: Choose NoSQL when your application requires high write throughput, horizontal scaling, or flexible schemas.\nüí™ ACID Properties: Reliability You Can Trust ACID is a set of properties that guarantee reliable database transactions:\nAtomicity: All operations succeed or none do. Consistency: Data remains valid after transactions. Isolation: Concurrent transactions don‚Äôt interfere. Durability: Committed data persists even after crashes. Relational databases excel at enforcing ACID properties, which are critical for financial systems, order processing, and anywhere data integrity matters.\nüîπ Tip: In distributed systems, understand when relaxing ACID is acceptable for performance gains (e.g., eventual consistency).\nACID describes how a database should execute transactions so your data stays correct even under failures and concurrency.\nA ‚Äî Atomicity (all-or-nothing) A transaction‚Äôs changes are applied entirely or not at all.\nIn Postgres: BEGIN ‚Ä¶ COMMIT applies; ROLLBACK undoes all.\nErrors inside a txn put it into an aborted state; either ROLLBACK or use savepoints to recover part-way.\nDDL is transactional in Postgres (rare in other DBs): schema changes roll back too.\n1 2 3 4 5 6 7 8 -- Example: money transfer with a savepoint BEGIN; SAVEPOINT before_debit; UPDATE accounts SET balance = balance - 100 WHERE id = 1; -- if a check fails, we can rollback to the savepoint instead of the whole txn -- ROLLBACK TO SAVEPOINT before_debit; UPDATE accounts SET balance = balance + 100 WHERE id = 2; COMMIT; C ‚Äî Consistency (valid state ‚Üí valid state) A transaction must move the database from one valid state to another, according to constraints you define.\nUse PRIMARY KEY, FOREIGN KEY, UNIQUE, CHECK, and EXCLUSION constraints to encode invariants.\nPostgres can defer some checks to the end of the transaction: DEFERRABLE INITIALLY DEFERRED.\n1 2 3 4 5 6 CREATE TABLE orders ( id BIGSERIAL PRIMARY KEY, customer_id BIGINT REFERENCES customers(id) DEFERRABLE INITIALLY DEFERRED, status TEXT CHECK (status IN ('new','paid','shipped','cancelled')) ); -- All FKs are checked at COMMIT time; useful for multi-row upserts. Consistency ‚â† ‚Äúbusiness correctness‚Äù by itself. The DB enforces what you encode; model your rules as constraints/triggers to get real guarantees.\nI ‚Äî Isolation (concurrent safety) Concurrent transactions shouldn‚Äôt step on each other. Postgres uses MVCC (multi-version concurrency control): readers don‚Äôt block writers; writers don‚Äôt block readers (most of the time).\nPostgres isolation levels (default READ COMMITTED):\nLevel Phenomena prevented Notes READ COMMITTED Dirty reads Each statement sees a fresh snapshot. Rows changed by concurrent transactions may appear/disappear between statements. REPEATABLE READ Dirty + non-repeatable reads; most phantoms Snapshot fixed for the whole transaction (aka snapshot isolation). Can still have write skew. SERIALIZABLE All above + write skew Detects anomalies (SSI) and may abort with 40001 serialization_failure ‚Äî you must retry. Locking primitives (pair with MVCC when needed):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 -- Claim a job row without blocking others UPDATE jobs SET claimed_by = :worker, claimed_at = now() WHERE id = ( SELECT id FROM jobs WHERE claimed_at IS NULL ORDER BY priority DESC, created_at FOR UPDATE SKIP LOCKED LIMIT 1 ) RETURNING *; -- Protect a row you will update soon SELECT * FROM accounts WHERE id = 1 FOR UPDATE NOWAIT; -- error if locked D ‚Äî Durability (it sticks) Once COMMITTED, data survives crashes.\nPostgres writes to the WAL (Write-Ahead Log) and fsyncs to disk.\nsynchronous_commit = on (default) waits for WAL flush; remote_apply can wait for replicas.\nTurning off fsync or using synchronous_commit = off risks data loss on crash ‚Äî OK for throwaway dev, not prod.\n1 2 3 -- Visibility knobs (know what they do before changing) SHOW synchronous_commit; -- on by default SHOW wal_level; -- replica/logical for replication/CDC Putting ACID together: a safe pattern 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 -- Pattern: retry on serialization/conflict DO $$ DECLARE tries int := 0; BEGIN \u003c\u003cretry\u003e\u003e BEGIN tries := tries + 1; -- choose isolation level suitable for invariants SET TRANSACTION ISOLATION LEVEL SERIALIZABLE; -- business logic here UPDATE inventory SET stock = stock - 1 WHERE sku = 'A' AND stock \u003e 0; IF NOT FOUND THEN RAISE EXCEPTION 'Out of stock'; END IF; COMMIT; EXCEPTION WHEN serialization_failure THEN ROLLBACK; IF tries \u003c 3 THEN PERFORM pg_sleep(0.01 * tries); GOTO retry; END IF; RAISE; -- give up WHEN OTHERS THEN ROLLBACK; RAISE; END; END$$; Guidelines\nDefault to READ COMMITTED; use REPEATABLE READ for consistent analytical reads; use SERIALIZABLE to protect complex invariants (and be ready to retry).\nKeep transactions short to reduce contention and bloat.\nPrefer idempotent writes (e.g., INSERT ‚Ä¶ ON CONFLICT DO NOTHING/UPDATE) to handle retries safely.\nACID in distributed systems A single-node ACID DB can‚Äôt make a network reliable. Across services you typically trade strict ACID for availability/latency.\nCommon patterns:\nOutbox/Inbox: write domain change + message to an outbox atomically; a relay publishes from the DB. Consumers write to an inbox table to get idempotency.\nSagas: break a business txn into steps with compensations (undo actions) ‚Äî eventual consistency.\n2PC (Two-Phase Commit): strong consistency across resources but operationally fragile; avoid unless you fully control all participants.\nIdempotency keys: ensure retried requests don‚Äôt duplicate side effects.\nRule of thumb: keep ACID for your core DB boundary; use idempotent, retryable workflows between services and accept eventual consistency where user experience allows.\nQuick ACID checklist (Postgres) Wrap multi-statement changes in BEGIN ‚Ä¶ COMMIT.\nEncode invariants as constraints; use DEFERRABLE when needed.\nUse proper isolation; retry on 40001 at SERIALIZABLE.\nUse SELECT ‚Ä¶ FOR UPDATE [SKIP LOCKED|NOWAIT] for queues/contention hotspots.\nMonitor WAL/replication; don‚Äôt disable fsync in prod.\nüìù Database Normalization: Design for Integrity Normalization organizes data to reduce redundancy and improve integrity.\nKey normal forms:\n1NF: Eliminate repeating groups. 2NF: Remove partial dependencies. 3NF: Remove transitive dependencies. While normalization ensures clean data design, sometimes selective denormalization is necessary for performance reasons in read-heavy systems.\nüîπ Tip: Normalize for clarity, denormalize for performance ‚Äî based on access patterns.\nüìù Database Normalization: Design for Integrity Normalization is the discipline of structuring tables so each fact is stored once and in the right place. Done well, it prevents data anomalies (bugs) and keeps writes simple and safe.\nWhy normalize? To avoid:\nUpdate anomaly ‚Äì you change a product‚Äôs name in one row but forget others.\nInsert anomaly ‚Äì you can‚Äôt add a new product until an order exists.\nDelete anomaly ‚Äì removing the last order for a product also erases the only copy of the product‚Äôs data.\nFunctional dependencies (intuitive view) If knowing X lets you determine Y, we write X ‚Üí Y. Examples:\ncustomer_id ‚Üí {customer_name, email}\nproduct_id ‚Üí {product_name, unit_price}\n(order_id, product_id) ‚Üí {qty}\nNormalization applies these rules to table design.\n1NF ‚Äî First Normal Form Rows are unique, columns are atomic (no arrays/CSV-in-a-cell), and order doesn‚Äôt matter.\nFix: move repeating groups to their own rows.\nSmelly design (repeating groups):\n1 orders(order_id, customer_id, items_sku_csv, items_qty_csv, ... ) 1NF shape (atomic rows):\n1 2 orders(order_id, customer_id, ordered_at, status) order_items(order_id, product_id, qty) 2NF ‚Äî Second Normal Form Applies when a table‚Äôs key is composite (e.g., (order_id, product_id)).\nEvery non-key column must depend on the whole key, not just part of it.\nSmelly design:\n1 2 order_items(order_id, product_id, qty, product_name, unit_price_current) -- product_* depend only on product_id (part of the key) ‚Üí violates 2NF 2NF fix: split product attributes out:\n1 2 products(product_id PRIMARY KEY, product_name, unit_price_current) order_items(order_id, product_id, qty, PRIMARY KEY(order_id, product_id)) 3NF ‚Äî Third Normal Form Non-key columns must depend only on the key (no transitive dependencies).\nIf order_id ‚Üí customer_id and customer_id ‚Üí customer_email, then order_id ‚Üí customer_email is transitive and shouldn‚Äôt live in orders.\nSmelly design:\n1 orders(order_id, customer_id, customer_email, ordered_at) 3NF fix:\n1 2 customers(customer_id PRIMARY KEY, name, email) orders(order_id PRIMARY KEY, customer_id REFERENCES customers, ordered_at) (Bonus) BCNF, 4NF, 5NF ‚Äî when things get tricky BCNF: a stronger 3NF; whenever a dependency X ‚Üí Y holds, X must be a key. Use when multiple candidate keys create odd dependencies.\n4NF: eliminates multi-valued dependencies (e.g., artist has multiple instruments and multiple genres ‚Üí use two separate link tables).\n5NF: decomposes tables so all joins are lossless; rarely needed outside complex M:N:N relationships.\nWorked example (from ‚Äúall-in-one‚Äù to normalized) Start (denormalized facts mixed together):\n1 2 3 4 5 orders_flat( order_id, ordered_at, customer_id, customer_name, customer_email, product_id, product_name, unit_price_current, qty ) Normalize ‚Üí canonical OLTP model:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 CREATE TABLE customers( customer_id BIGINT PRIMARY KEY, name TEXT NOT NULL, email TEXT NOT NULL UNIQUE ); CREATE TABLE products( product_id BIGINT PRIMARY KEY, name TEXT NOT NULL, unit_price_cents INT NOT NULL CHECK (unit_price_cents \u003e= 0) ); CREATE TABLE orders( order_id BIGINT PRIMARY KEY, customer_id BIGINT NOT NULL REFERENCES customers(customer_id), ordered_at TIMESTAMPTZ NOT NULL DEFAULT now(), status TEXT NOT NULL CHECK (status IN ('new','paid','shipped','cancelled')) ); CREATE TABLE order_items( order_id BIGINT NOT NULL REFERENCES orders(order_id) ON DELETE CASCADE, product_id BIGINT NOT NULL REFERENCES products(product_id), qty INT NOT NULL CHECK (qty \u003e 0), unit_price_cents INT NOT NULL, -- snapshot at purchase time PRIMARY KEY(order_id, product_id) ); Why the unit_price_cents copy in order_items?\nNormalization doesn‚Äôt forbid capturing a historical snapshot. Prices change; you still need the price that applied at checkout to compute totals later. This is a legit denormalization for history, not a smell.\nPostgres tools that help enforce normalization Foreign keys with actions: ON DELETE CASCADE/RESTRICT, DEFERRABLE INITIALLY DEFERRED for multi-row transactions.\nUnique constraints / composite keys to model natural identities.\nCHECK constraints for business rules (status IN (‚Ä¶), positive amounts).\nPartial unique indexes to scope rules (e.g., unique SKU per active catalog).\nExclusion constraints for scheduling overlaps (via btree_gist).\nWhen (and how) to denormalize safely Normalize your write path, then denormalize your read path when profiling shows hot queries need it.\nCommon, safe patterns:\nMaterialized views: precompute aggregates; refresh on schedule.\nSummary tables updated by jobs/triggers (e.g., daily revenue per product).\nStar schema in analytics (facts + dimensions) while OLTP remains 3NF.\nSelective duplication (e.g., orders.total_cents) maintained by trigger or app logic.\nJSONB columns for truly sparse, non-relational attributes‚Äîbut index extracted fields you query (CREATE INDEX ‚Ä¶ ( (props-¬ª‚Äòcolor‚Äô) )).\nTrade-offs: faster reads vs. risk of drift. Always document the single source of truth and how denormalized fields are refreshed.\nOne-minute normalization checklist Key: What uniquely identifies a row? (Write it down.)\nFDs: List obvious dependencies (e.g., product_id ‚Üí name, price).\n1NF: Any arrays/CSV/duplicate groups in a row? Split to rows.\n2NF: With composite keys, does every non-key depend on the whole key?\n3NF: Any non-key depending on another non-key? Move it out.\nIntegrity: Add PKs, FKs, UNIQUE, CHECKs.\nPerformance: Add indexes that match your most common WHERE/JOIN/ORDER BY.\nNormalize for correctness; denormalize deliberately for speed with clear ownership and refresh logic.\nüîÑ Wrapping Up Understanding databases isn‚Äôt just about memorizing SQL queries. It‚Äôs about knowing how data structures (like B-Trees), transaction guarantees (ACID), and design principles (normalization) affect your application‚Äôs performance, reliability, and scalability.\nWhether you‚Äôre architecting a high-availability service or fine-tuning a reporting dashboard, strong database knowledge will elevate your solutions.\nüöÄ Follow me on norbix.dev for more insights on Go, Python, AI, system design, and engineering wisdom.\n","wordCount":"2825","inLanguage":"en","datePublished":"2025-04-28T18:00:00+02:00","dateModified":"2025-04-28T18:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://norbix.dev/posts/databases/"},"publisher":{"@type":"Organization","name":"norbix.dev - The log of my journey through code \u0026 software systems architecture","logo":{"@type":"ImageObject","url":"https://norbix.dev/favicon.ico"}}}</script></head><body><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://norbix.dev/ accesskey=h title="norbix.dev - The log of my journey through code & software systems architecture (Alt + H)">norbix.dev - The log of my journey through code & software systems architecture</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://norbix.dev/ title=Home><span>Home</span></a></li><li><a href=https://norbix.dev/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://norbix.dev/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://norbix.dev/about/ title=About><span>About</span></a></li><li><a href=https://norbix.dev/index.xml title="üì° RSS"><span>üì° RSS</span></a></li></ul></nav></header><main><main id=main><article class=post-single><header class=post-header><h1 class=post-title>Understanding Databases: B-Trees, SQL, NoSQL, ACID, and Normalization</h1><span title='2025-04-28 18:00:00 +0200 +0200'>April 28, 2025</span></header><div class=post-content><nav class=table-of-contents><nav id=TableOfContents><ul><li><a href=#-b-trees-the-backbone-of-indexing>üìö B-Trees: The Backbone of Indexing</a></li><li><a href=#-sql-structured-query-language>üìÇ SQL: Structured Query Language</a><ul><li><a href=#-postgresql-quick-start-copypaste>üî∞ PostgreSQL quick start (copy‚Äìpaste)</a></li><li><a href=#common-pitfalls-postgres>Common pitfalls (Postgres)</a></li></ul></li><li><a href=#-nosql-flexibility-at-scale>üîÑ NoSQL: Flexibility at Scale</a></li><li><a href=#-acid-properties-reliability-you-can-trust>üí™ ACID Properties: Reliability You Can Trust</a><ul><li><a href=#a--atomicity-all-or-nothing>A ‚Äî Atomicity (all-or-nothing)</a></li><li><a href=#c--consistency-valid-state--valid-state>C ‚Äî Consistency (valid state ‚Üí valid state)</a></li><li><a href=#i--isolation-concurrent-safety>I ‚Äî Isolation (concurrent safety)</a></li><li><a href=#d--durability-it-sticks>D ‚Äî Durability (it sticks)</a></li><li><a href=#putting-acid-together-a-safe-pattern>Putting ACID together: a safe pattern</a></li><li><a href=#acid-in-distributed-systems>ACID in distributed systems</a></li><li><a href=#quick-acid-checklist-postgres>Quick ACID checklist (Postgres)</a></li></ul></li><li><a href=#-database-normalization-design-for-integrity>üìù Database Normalization: Design for Integrity</a><ul><li><a href=#-database-normalization-design-for-integrity-1>üìù Database Normalization: Design for Integrity</a></li></ul></li><li><a href=#-wrapping-up>üîÑ Wrapping Up</a></li></ul></nav></nav><p><img loading=lazy src=banner.jpg alt=banner></p><p><strong>&ldquo;Bad data ruins good applications. Good databases build great systems.&rdquo;</strong></p><p>Databases are the silent powerhouse behind most modern applications. Whether you‚Äôre building a simple blog, an enterprise CRM, or a distributed IoT system, understanding database fundamentals can dramatically improve the quality and scalability of your software.</p><p>In this article, I‚Äôll walk through essential database concepts every engineer should master: B-Trees, SQL, NoSQL, ACID properties, and normalization.</p><hr><h2 id=-b-trees-the-backbone-of-indexing>üìö B-Trees: The Backbone of Indexing</h2><p>Efficient data retrieval is crucial, and that&rsquo;s where B-Trees come in. B-Trees are balanced tree structures that allow fast search, insert, and delete operations in logarithmic time.</p><p>In databases like MySQL (InnoDB) and PostgreSQL, indexes are often implemented as B-Trees, making queries much faster by avoiding full table scans.</p><p>üîπ <strong>Tip:</strong> Always index columns used in WHERE, JOIN, and ORDER BY clauses to leverage B-Tree advantages.</p><hr><h2 id=-sql-structured-query-language>üìÇ SQL: Structured Query Language</h2><p>SQL is the standard language for querying and manipulating relational databases.</p><p>Key operations:</p><ul><li><code>SELECT</code>: Retrieve data</li><li><code>INSERT</code>: Add new records</li><li><code>UPDATE</code>: Modify existing records</li><li><code>DELETE</code>: Remove records</li></ul><p>SQL enforces a strict schema and supports relationships, making it ideal for structured data.</p><p>Popular SQL databases: PostgreSQL, MySQL, MariaDB, Microsoft SQL Server.</p><p>üîπ <strong>Tip:</strong> Master <code>JOIN</code> operations and subqueries to unlock SQL&rsquo;s full power.</p><h3 id=-postgresql-quick-start-copypaste>üî∞ PostgreSQL quick start (copy‚Äìpaste)</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- One-time sandbox
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>SCHEMA</span><span class=w> </span><span class=n>learnsql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>search_path</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>learnsql</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>author_id</span><span class=w> </span><span class=n>BIGSERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>name</span><span class=w>      </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>country</span><span class=w>   </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>book_id</span><span class=w>    </span><span class=n>BIGSERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>author_id</span><span class=w>  </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>authors</span><span class=p>(</span><span class=n>author_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>title</span><span class=w>      </span><span class=nb>TEXT</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>year</span><span class=w>       </span><span class=nb>INT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>price_usd</span><span class=w>  </span><span class=nb>NUMERIC</span><span class=p>(</span><span class=mi>6</span><span class=p>,</span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>CHECK</span><span class=w> </span><span class=p>(</span><span class=n>price_usd</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=s1>&#39;Alicja Kowalska&#39;</span><span class=p>,</span><span class=s1>&#39;PL&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Bartosz Nowak&#39;</span><span class=p>,</span><span class=s1>&#39;PL&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=s1>&#39;Chloe Schneider&#39;</span><span class=p>,</span><span class=s1>&#39;DE&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Diego Garc√≠a&#39;</span><span class=p>,</span><span class=s1>&#39;ES&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=p>(</span><span class=n>author_id</span><span class=p>,</span><span class=n>title</span><span class=p>,</span><span class=k>year</span><span class=p>,</span><span class=n>price_usd</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>&#39;SQL for Starters&#39;</span><span class=p>,</span><span class=mi>2023</span><span class=p>,</span><span class=mi>29</span><span class=p>.</span><span class=mi>99</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=s1>&#39;Advanced SQL Patterns&#39;</span><span class=p>,</span><span class=mi>2025</span><span class=p>,</span><span class=mi>39</span><span class=p>.</span><span class=mi>50</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;Data Modeling 101&#39;</span><span class=p>,</span><span class=mi>2022</span><span class=p>,</span><span class=mi>24</span><span class=p>.</span><span class=mi>00</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=s1>&#39;PostgreSQL Cookbook&#39;</span><span class=p>,</span><span class=mi>2024</span><span class=p>,</span><span class=mi>35</span><span class=p>.</span><span class=mi>00</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>3</span><span class=p>,</span><span class=s1>&#39;Window Functions in Practice&#39;</span><span class=p>,</span><span class=mi>2024</span><span class=p>,</span><span class=mi>32</span><span class=p>.</span><span class=mi>00</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;Indexing and Performance&#39;</span><span class=p>,</span><span class=mi>2021</span><span class=p>,</span><span class=mi>27</span><span class=p>.</span><span class=mi>50</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>(</span><span class=mi>4</span><span class=p>,</span><span class=s1>&#39;JSON in Postgres&#39;</span><span class=p>,</span><span class=mi>2025</span><span class=p>,</span><span class=mi>31</span><span class=p>.</span><span class=mi>00</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=select--filter>Select & filter</h4><p>Select specific columns, filter with <code>WHERE</code>, sort with <code>ORDER BY</code>, and limit results with <code>LIMIT</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>price_usd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>price_usd</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>price_usd</span><span class=w> </span><span class=k>DESC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=joins>Joins</h4><p>Joins combine rows from two or more tables based on related columns.</p><p>A SQL JOIN doesn‚Äôt permanently merge tables; it builds a wider result set at query time by pairing rows whose keys match your condition.
Think of it as a lookup that produces a new, temporary table.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- All books with author info
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>author</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=k>year</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>price_usd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=n>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>author_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>author_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=k>year</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=aggregation>Aggregation</h4><p>Aggregate functions summarize data: <code>COUNT()</code>, <code>SUM()</code>, <code>AVG()</code>, <code>MIN()</code>, <code>MAX()</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Avg price by country; only countries with ‚â•2 books
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>country</span><span class=p>,</span><span class=w>                              </span><span class=c1>-- 1) grouping key (country)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>       </span><span class=n>ROUND</span><span class=p>(</span><span class=k>AVG</span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=n>price_usd</span><span class=p>),</span><span class=w> </span><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>avg_price</span><span class=w> </span><span class=c1>-- 2) average book price, 2 decimals
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=n>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>author_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>author_id</span><span class=w>    </span><span class=c1>-- 3) attach each book to its author&#39;s country
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>country</span><span class=w>                             </span><span class=c1>-- 4) aggregate per country
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>HAVING</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>2</span><span class=w>                           </span><span class=c1>-- 5) keep only countries with 2+ books
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>avg_price</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span><span class=w>                       </span><span class=c1>-- 6) sort by avg price, highest first
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Hint: <code>GROUP BY</code> vs <code>ORDER BY</code></strong></p><ul><li><p><code>GROUP BY</code> partitions rows into groups and reduces them (with aggregates like COUNT, AVG, SUM).</p></li><li><p><code>ORDER BY</code> sorts the final rows (whatever they are‚Äîraw or aggregated).</p></li></ul><p>They do different jobs and often appear together.</p><h4 id=useful-operators>Useful operators</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Case-insensitive search
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>ILIKE</span><span class=w> </span><span class=s1>&#39;%sql%&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Categorize with CASE
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>title</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>price_usd</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>35</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;premium&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>WHEN</span><span class=w> </span><span class=n>price_usd</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>30</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;mid&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>ELSE</span><span class=w> </span><span class=s1>&#39;budget&#39;</span><span class=w> </span><span class=k>END</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>price_tier</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Distinct values
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>country</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=ctes-with--subqueries>CTEs (WITH) & subqueries</h4><p>CTE (Common Table Expression) example:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Authors whose average book price &gt; $30
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>WITH</span><span class=w> </span><span class=n>avg_price</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>SELECT</span><span class=w> </span><span class=n>author_id</span><span class=p>,</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>price_usd</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>avg_price</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>author_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>ap</span><span class=p>.</span><span class=n>avg_price</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>avg_price</span><span class=w> </span><span class=n>ap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>author_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ap</span><span class=p>.</span><span class=n>author_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>ap</span><span class=p>.</span><span class=n>avg_price</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>30</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=window-functions-analytics-without-collapsing-rows>Window functions (analytics without collapsing rows)</h4><p>Functions like <code>ROW_NUMBER()</code>, <code>RANK()</code>, <code>SUM() OVER()</code>, etc., operate over a set of rows related to the current row.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Rank the most expensive book per author
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>title</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>price_usd</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       </span><span class=n>RANK</span><span class=p>()</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>author_id</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>price_usd</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>rnk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=n>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>authors</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>author_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>.</span><span class=n>author_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>rnk</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=indexes--explain-performance-mindset>Indexes & EXPLAIN (performance mindset)</h4><p>Indexes speed up lookups but slow down writes and take space. Use them wisely.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_books_author_year</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>books</span><span class=p>(</span><span class=n>author_id</span><span class=p>,</span><span class=w> </span><span class=k>year</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXPLAIN</span><span class=w> </span><span class=k>ANALYZE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>author_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>year</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>2024</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=k>year</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>If you see a sequential scan on a large table, consider whether your index matches the filter and order columns (and their order).</p><h3 id=common-pitfalls-postgres>Common pitfalls (Postgres)</h3><ul><li><p>Strings use single quotes (&lsquo;PL&rsquo;). Double quotes are identifiers.</p></li><li><p>NULL logic: use IS NULL / IS NOT NULL; = NULL is never true.</p></li><li><p>Integer division: 1/2 = 0. Cast for rates: sum(x)::numeric / nullif(count(*),0).</p></li><li><p>All non-aggregated SELECT columns must appear in GROUP BY.</p></li><li><p>Prefer window functions for ‚Äútop-k per group‚Äù and ‚Äúrolling‚Äù metrics.</p></li></ul><hr><h2 id=-nosql-flexibility-at-scale>üîÑ NoSQL: Flexibility at Scale</h2><p>NoSQL databases emerged to handle massive, unstructured, and rapidly changing data.</p><p>Types of NoSQL databases:</p><ul><li>Document stores: MongoDB, Couchbase</li><li>Key-value stores: Redis, DynamoDB</li><li>Wide-column stores: Cassandra, HBase</li><li>Graph databases: Neo4j, Amazon Neptune</li></ul><p>NoSQL systems often prioritize availability and partition tolerance (CAP theorem) over strict consistency.</p><p>üîπ <strong>Tip:</strong> Choose NoSQL when your application requires high write throughput, horizontal scaling, or flexible schemas.</p><hr><h2 id=-acid-properties-reliability-you-can-trust>üí™ ACID Properties: Reliability You Can Trust</h2><p>ACID is a set of properties that guarantee reliable database transactions:</p><ul><li>Atomicity: All operations succeed or none do.</li><li>Consistency: Data remains valid after transactions.</li><li>Isolation: Concurrent transactions don&rsquo;t interfere.</li><li>Durability: Committed data persists even after crashes.</li></ul><p>Relational databases excel at enforcing ACID properties, which are critical for financial systems, order processing, and anywhere data integrity matters.</p><p>üîπ <strong>Tip:</strong> In distributed systems, understand when relaxing ACID is acceptable for performance gains (e.g., eventual consistency).</p><p><code>ACID</code> describes how a database should execute transactions so your data stays correct even under failures and concurrency.</p><h3 id=a--atomicity-all-or-nothing>A ‚Äî Atomicity (all-or-nothing)</h3><p>A transaction‚Äôs changes are applied entirely or not at all.</p><ul><li><p>In Postgres: BEGIN ‚Ä¶ COMMIT applies; ROLLBACK undoes all.</p></li><li><p>Errors inside a txn put it into an aborted state; either ROLLBACK or use savepoints to recover part-way.</p></li><li><p>DDL is transactional in Postgres (rare in other DBs): schema changes roll back too.</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Example: money transfer with a savepoint
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SAVEPOINT</span><span class=w> </span><span class=n>before_debit</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- if a check fails, we can rollback to the savepoint instead of the whole txn
</span></span></span><span class=line><span class=cl><span class=c1>-- ROLLBACK TO SAVEPOINT before_debit;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=c--consistency-valid-state--valid-state>C ‚Äî Consistency (valid state ‚Üí valid state)</h3><p>A transaction must move the database from one valid state to another, according to constraints you define.</p><ul><li><p>Use PRIMARY KEY, FOREIGN KEY, UNIQUE, CHECK, and EXCLUSION constraints to encode invariants.</p></li><li><p>Postgres can defer some checks to the end of the transaction: <code>DEFERRABLE INITIALLY DEFERRED</code>.</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>id</span><span class=w> </span><span class=n>BIGSERIAL</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>customer_id</span><span class=w> </span><span class=nb>BIGINT</span><span class=w> </span><span class=k>REFERENCES</span><span class=w> </span><span class=n>customers</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=k>DEFERRABLE</span><span class=w> </span><span class=k>INITIALLY</span><span class=w> </span><span class=k>DEFERRED</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>status</span><span class=w> </span><span class=nb>TEXT</span><span class=w> </span><span class=k>CHECK</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;new&#39;</span><span class=p>,</span><span class=s1>&#39;paid&#39;</span><span class=p>,</span><span class=s1>&#39;shipped&#39;</span><span class=p>,</span><span class=s1>&#39;cancelled&#39;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- All FKs are checked at COMMIT time; useful for multi-row upserts.
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Consistency ‚â† ‚Äúbusiness correctness‚Äù by itself. The DB enforces what you encode; model your rules as constraints/triggers to get real guarantees.</strong></p><h3 id=i--isolation-concurrent-safety>I ‚Äî Isolation (concurrent safety)</h3><p>Concurrent transactions shouldn‚Äôt step on each other. Postgres uses MVCC (multi-version concurrency control): readers don‚Äôt block writers; writers don‚Äôt block readers (most of the time).</p><p>Postgres isolation levels (default READ COMMITTED):</p><table><thead><tr><th>Level</th><th>Phenomena prevented</th><th>Notes</th></tr></thead><tbody><tr><td>READ COMMITTED</td><td>Dirty reads</td><td>Each statement sees a fresh snapshot. Rows changed by concurrent transactions may appear/disappear between statements.</td></tr><tr><td>REPEATABLE READ</td><td>Dirty + non-repeatable reads; most phantoms</td><td>Snapshot fixed for the whole transaction (aka snapshot isolation). Can still have write skew.</td></tr><tr><td>SERIALIZABLE</td><td>All above + write skew</td><td>Detects anomalies (SSI) and may abort with <code>40001 serialization_failure</code> ‚Äî you must retry.</td></tr></tbody></table><p>Locking primitives (pair with MVCC when needed):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Claim a job row without blocking others
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>UPDATE</span><span class=w> </span><span class=n>jobs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SET</span><span class=w> </span><span class=n>claimed_by</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>:</span><span class=n>worker</span><span class=p>,</span><span class=w> </span><span class=n>claimed_at</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>jobs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>claimed_at</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>priority</span><span class=w> </span><span class=k>DESC</span><span class=p>,</span><span class=w> </span><span class=n>created_at</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>SKIP</span><span class=w> </span><span class=n>LOCKED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RETURNING</span><span class=w> </span><span class=o>*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- Protect a row you will update soon
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>FOR</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>NOWAIT</span><span class=p>;</span><span class=w> </span><span class=c1>-- error if locked
</span></span></span></code></pre></td></tr></table></div></div><h3 id=d--durability-it-sticks>D ‚Äî Durability (it sticks)</h3><p>Once COMMITTED, data survives crashes.</p><ul><li><p>Postgres writes to the WAL (Write-Ahead Log) and fsyncs to disk.</p></li><li><p>synchronous_commit = on (default) waits for WAL flush; remote_apply can wait for replicas.</p></li><li><p>Turning off fsync or using synchronous_commit = off risks data loss on crash ‚Äî OK for throwaway dev, not prod.</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Visibility knobs (know what they do before changing)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=n>synchronous_commit</span><span class=p>;</span><span class=w> </span><span class=c1>-- on by default
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=n>wal_level</span><span class=p>;</span><span class=w> </span><span class=c1>-- replica/logical for replication/CDC
</span></span></span></code></pre></td></tr></table></div></div><h3 id=putting-acid-together-a-safe-pattern>Putting ACID together: a safe pattern</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- Pattern: retry on serialization/conflict
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DO</span><span class=w> </span><span class=err>$$</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DECLARE</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>tries</span><span class=w> </span><span class=nb>int</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;&lt;</span><span class=n>retry</span><span class=o>&gt;&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>tries</span><span class=w> </span><span class=p>:</span><span class=o>=</span><span class=w> </span><span class=n>tries</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- choose isolation level suitable for invariants
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=k>TRANSACTION</span><span class=w> </span><span class=k>ISOLATION</span><span class=w> </span><span class=k>LEVEL</span><span class=w> </span><span class=k>SERIALIZABLE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- business logic here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>UPDATE</span><span class=w> </span><span class=n>inventory</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>sku</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;A&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=n>stock</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>IF</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>FOUND</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=n>RAISE</span><span class=w> </span><span class=k>EXCEPTION</span><span class=w> </span><span class=s1>&#39;Out of stock&#39;</span><span class=p>;</span><span class=w> </span><span class=k>END</span><span class=w> </span><span class=k>IF</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>EXCEPTION</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>serialization_failure</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ROLLBACK</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>IF</span><span class=w> </span><span class=n>tries</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>3</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=n>PERFORM</span><span class=w> </span><span class=n>pg_sleep</span><span class=p>(</span><span class=mi>0</span><span class=p>.</span><span class=mi>01</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>tries</span><span class=p>);</span><span class=w> </span><span class=k>GOTO</span><span class=w> </span><span class=n>retry</span><span class=p>;</span><span class=w> </span><span class=k>END</span><span class=w> </span><span class=k>IF</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>RAISE</span><span class=p>;</span><span class=w> </span><span class=c1>-- give up
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>WHEN</span><span class=w> </span><span class=n>OTHERS</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ROLLBACK</span><span class=p>;</span><span class=w> </span><span class=n>RAISE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>END</span><span class=err>$$</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Guidelines</p><ul><li><p>Default to READ COMMITTED; use REPEATABLE READ for consistent analytical reads; use SERIALIZABLE to protect complex invariants (and be ready to retry).</p></li><li><p>Keep transactions short to reduce contention and bloat.</p></li><li><p>Prefer idempotent writes (e.g., INSERT ‚Ä¶ ON CONFLICT DO NOTHING/UPDATE) to handle retries safely.</p></li></ul><h3 id=acid-in-distributed-systems>ACID in distributed systems</h3><p>A single-node ACID DB can‚Äôt make a network reliable. Across services you typically trade strict ACID for availability/latency.</p><p>Common patterns:</p><ul><li><p>Outbox/Inbox: write domain change + message to an outbox atomically; a relay publishes from the DB. Consumers write to an inbox table to get idempotency.</p></li><li><p>Sagas: break a business txn into steps with compensations (undo actions) ‚Äî eventual consistency.</p></li><li><p>2PC (Two-Phase Commit): strong consistency across resources but operationally fragile; avoid unless you fully control all participants.</p></li><li><p>Idempotency keys: ensure retried requests don‚Äôt duplicate side effects.</p></li></ul><p>Rule of thumb: keep ACID for your core DB boundary; use idempotent, retryable workflows between services and accept eventual consistency where user experience allows.</p><h3 id=quick-acid-checklist-postgres>Quick ACID checklist (Postgres)</h3><ul><li><p>Wrap multi-statement changes in <code>BEGIN ‚Ä¶ COMMIT</code>.</p></li><li><p>Encode invariants as constraints; use DEFERRABLE when needed.</p></li><li><p>Use proper isolation; retry on 40001 at SERIALIZABLE.</p></li><li><p>Use <code>SELECT ‚Ä¶ FOR UPDATE [SKIP LOCKED|NOWAIT]</code> for queues/contention hotspots.</p></li><li><p>Monitor WAL/replication; don‚Äôt disable <code>fsync</code> in prod.</p></li></ul><hr><h2 id=-database-normalization-design-for-integrity>üìù Database Normalization: Design for Integrity</h2><p>Normalization organizes data to reduce redundancy and improve integrity.</p><p>Key normal forms:</p><ul><li><strong>1NF</strong>: Eliminate repeating groups.</li><li><strong>2NF</strong>: Remove partial dependencies.</li><li><strong>3NF</strong>: Remove transitive dependencies.</li></ul><p>While normalization ensures clean data design, sometimes selective denormalization is necessary for performance reasons in read-heavy systems.</p><p>üîπ <strong>Tip:</strong> Normalize for clarity, denormalize for performance ‚Äî based on access patterns.</p><h3 id=-database-normalization-design-for-integrity-1>üìù Database Normalization: Design for Integrity</h3><p>Normalization is the discipline of structuring tables so each fact is stored once and in the right place. Done well, it prevents data anomalies (bugs) and keeps writes simple and safe.</p><p>Why normalize? To avoid:</p><ul><li><p>Update anomaly ‚Äì you change a product‚Äôs name in one row but forget others.</p></li><li><p>Insert anomaly ‚Äì you can‚Äôt add a new product until an order exists.</p></li><li><p>Delete anomaly ‚Äì removing the last order for a product also erases the only copy of the product‚Äôs data.</p></li></ul><h4 id=functional-dependencies-intuitive-view>Functional dependencies (intuitive view)</h4><p>If knowing X lets you determine Y, we write X ‚Üí Y.
Examples:</p><ul><li><p>customer_id ‚Üí {customer_name, email}</p></li><li><p>product_id ‚Üí {product_name, unit_price}</p></li><li><p>(order_id, product_id) ‚Üí {qty}</p></li></ul><p>Normalization applies these rules to table design.</p><h4 id=1nf--first-normal-form>1NF ‚Äî First Normal Form</h4><p>Rows are unique, columns are atomic (no arrays/CSV-in-a-cell), and order doesn‚Äôt matter.</p><ul><li><p>Fix: move repeating groups to their own rows.</p></li><li><p>Smelly design (repeating groups):</p></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>orders</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>customer_id</span><span class=o>,</span> <span class=nt>items_sku_csv</span><span class=o>,</span> <span class=nt>items_qty_csv</span><span class=o>,</span> <span class=nc>...</span> <span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>1NF</code> shape (atomic rows):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>orders</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>customer_id</span><span class=o>,</span> <span class=nt>ordered_at</span><span class=o>,</span> <span class=nt>status</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nt>order_items</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>product_id</span><span class=o>,</span> <span class=nt>qty</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2nf--second-normal-form>2NF ‚Äî Second Normal Form</h4><ul><li><p>Applies when a table‚Äôs key is composite (e.g., (order_id, product_id)).</p></li><li><p>Every non-key column must depend on the whole key, not just part of it.</p></li></ul><p>Smelly design:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>order_items</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>product_id</span><span class=o>,</span> <span class=nt>qty</span><span class=o>,</span> <span class=nt>product_name</span><span class=o>,</span> <span class=nt>unit_price_current</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>--</span> <span class=nt>product_</span><span class=o>*</span> <span class=nt>depend</span> <span class=nt>only</span> <span class=nt>on</span> <span class=nt>product_id</span> <span class=o>(</span><span class=nt>part</span> <span class=nt>of</span> <span class=nt>the</span> <span class=nt>key</span><span class=o>)</span> <span class=err>‚Üí</span> <span class=nt>violates</span> <span class=nt>2NF</span>
</span></span></code></pre></td></tr></table></div></div><p><code>2NF</code> fix: split product attributes out:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>products</span><span class=o>(</span><span class=nt>product_id</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>,</span> <span class=nt>product_name</span><span class=o>,</span> <span class=nt>unit_price_current</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nt>order_items</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>product_id</span><span class=o>,</span> <span class=nt>qty</span><span class=o>,</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>product_id</span><span class=o>))</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3nf--third-normal-form>3NF ‚Äî Third Normal Form</h4><ul><li><p>Non-key columns must depend only on the key (no transitive dependencies).</p></li><li><p>If order_id ‚Üí customer_id and customer_id ‚Üí customer_email, then order_id ‚Üí customer_email is transitive and shouldn‚Äôt live in orders.</p></li></ul><p>Smelly design:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>orders</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>customer_id</span><span class=o>,</span> <span class=nt>customer_email</span><span class=o>,</span> <span class=nt>ordered_at</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p><code>3NF</code> fix:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>customers</span><span class=o>(</span><span class=nt>customer_id</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>,</span> <span class=nt>name</span><span class=o>,</span> <span class=nt>email</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nt>orders</span><span class=o>(</span><span class=nt>order_id</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>,</span> <span class=nt>customer_id</span> <span class=nt>REFERENCES</span> <span class=nt>customers</span><span class=o>,</span> <span class=nt>ordered_at</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=bonus-bcnf-4nf-5nf--when-things-get-tricky>(Bonus) BCNF, 4NF, 5NF ‚Äî when things get tricky</h4><ul><li><p><code>BCNF</code>: a stronger 3NF; whenever a dependency X ‚Üí Y holds, X must be a key. Use when multiple candidate keys create odd dependencies.</p></li><li><p><code>4NF</code>: eliminates multi-valued dependencies (e.g., artist has multiple instruments and multiple genres ‚Üí use two separate link tables).</p></li><li><p><code>5NF</code>: decomposes tables so all joins are lossless; rarely needed outside complex M:N:N relationships.</p></li></ul><h4 id=worked-example-from-all-in-one-to-normalized>Worked example (from ‚Äúall-in-one‚Äù to normalized)</h4><p>Start (denormalized facts mixed together):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>orders_flat</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=nt>order_id</span><span class=o>,</span> <span class=nt>ordered_at</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>customer_id</span><span class=o>,</span> <span class=nt>customer_name</span><span class=o>,</span> <span class=nt>customer_email</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>product_id</span><span class=o>,</span> <span class=nt>product_name</span><span class=o>,</span> <span class=nt>unit_price_current</span><span class=o>,</span> <span class=nt>qty</span>
</span></span><span class=line><span class=cl><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>Normalize ‚Üí canonical OLTP model:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>CREATE</span> <span class=nt>TABLE</span> <span class=nt>customers</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=nt>customer_id</span> <span class=nt>BIGINT</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>name</span> <span class=nt>TEXT</span> <span class=nt>NOT</span> <span class=nt>NULL</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>email</span> <span class=nt>TEXT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>UNIQUE</span>
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>CREATE</span> <span class=nt>TABLE</span> <span class=nt>products</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=nt>product_id</span> <span class=nt>BIGINT</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>name</span> <span class=nt>TEXT</span> <span class=nt>NOT</span> <span class=nt>NULL</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>unit_price_cents</span> <span class=nt>INT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>CHECK</span> <span class=o>(</span><span class=nt>unit_price_cents</span> <span class=o>&gt;=</span> <span class=nt>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>CREATE</span> <span class=nt>TABLE</span> <span class=nt>orders</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=nt>order_id</span> <span class=nt>BIGINT</span> <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>customer_id</span> <span class=nt>BIGINT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>REFERENCES</span> <span class=nt>customers</span><span class=o>(</span><span class=nt>customer_id</span><span class=o>),</span>
</span></span><span class=line><span class=cl>  <span class=nt>ordered_at</span> <span class=nt>TIMESTAMPTZ</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>DEFAULT</span> <span class=nt>now</span><span class=o>(),</span>
</span></span><span class=line><span class=cl>  <span class=nt>status</span> <span class=nt>TEXT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>CHECK</span> <span class=o>(</span><span class=nt>status</span> <span class=nt>IN</span> <span class=o>(</span><span class=s1>&#39;new&#39;</span><span class=o>,</span><span class=s1>&#39;paid&#39;</span><span class=o>,</span><span class=s1>&#39;shipped&#39;</span><span class=o>,</span><span class=s1>&#39;cancelled&#39;</span><span class=o>))</span>
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>CREATE</span> <span class=nt>TABLE</span> <span class=nt>order_items</span><span class=o>(</span>
</span></span><span class=line><span class=cl>  <span class=nt>order_id</span> <span class=nt>BIGINT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>REFERENCES</span> <span class=nt>orders</span><span class=o>(</span><span class=nt>order_id</span><span class=o>)</span> <span class=nt>ON</span> <span class=nt>DELETE</span> <span class=nt>CASCADE</span><span class=o>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>product_id</span> <span class=nt>BIGINT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>REFERENCES</span> <span class=nt>products</span><span class=o>(</span><span class=nt>product_id</span><span class=o>),</span>
</span></span><span class=line><span class=cl>  <span class=nt>qty</span> <span class=nt>INT</span> <span class=nt>NOT</span> <span class=nt>NULL</span> <span class=nt>CHECK</span> <span class=o>(</span><span class=nt>qty</span> <span class=o>&gt;</span> <span class=nt>0</span><span class=o>),</span>
</span></span><span class=line><span class=cl>  <span class=nt>unit_price_cents</span> <span class=nt>INT</span> <span class=nt>NOT</span> <span class=nt>NULL</span><span class=o>,</span>           <span class=o>--</span> <span class=nt>snapshot</span> <span class=nt>at</span> <span class=nt>purchase</span> <span class=nt>time</span>
</span></span><span class=line><span class=cl>  <span class=nt>PRIMARY</span> <span class=nt>KEY</span><span class=o>(</span><span class=nt>order_id</span><span class=o>,</span> <span class=nt>product_id</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>)</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Why the unit_price_cents copy in order_items?</strong></p><p>Normalization doesn‚Äôt forbid capturing a historical snapshot. Prices change; you still need the price that applied at checkout to compute totals later. This is a legit denormalization for history, not a smell.</p><h4 id=postgres-tools-that-help-enforce-normalization>Postgres tools that help enforce normalization</h4><ul><li><p>Foreign keys with actions: ON DELETE CASCADE/RESTRICT, DEFERRABLE INITIALLY DEFERRED for multi-row transactions.</p></li><li><p>Unique constraints / composite keys to model natural identities.</p></li><li><p>CHECK constraints for business rules (status IN (&mldr;), positive amounts).</p></li><li><p>Partial unique indexes to scope rules (e.g., unique SKU per active catalog).</p></li><li><p>Exclusion constraints for scheduling overlaps (via btree_gist).</p></li></ul><h4 id=when-and-how-to-denormalize-safely>When (and how) to denormalize safely</h4><p>Normalize your write path, then denormalize your read path when profiling shows hot queries need it.</p><p>Common, safe patterns:</p><ul><li><p>Materialized views: precompute aggregates; refresh on schedule.</p></li><li><p>Summary tables updated by jobs/triggers (e.g., daily revenue per product).</p></li><li><p>Star schema in analytics (facts + dimensions) while OLTP remains 3NF.</p></li><li><p>Selective duplication (e.g., orders.total_cents) maintained by trigger or app logic.</p></li><li><p>JSONB columns for truly sparse, non-relational attributes‚Äîbut index extracted fields you query (CREATE INDEX &mldr; ( (props-&#187;&lsquo;color&rsquo;) )).</p></li></ul><p>Trade-offs: faster reads vs. risk of drift. Always document the single source of truth and how denormalized fields are refreshed.</p><h4 id=one-minute-normalization-checklist>One-minute normalization checklist</h4><ul><li><p><code>Key</code>: What uniquely identifies a row? (Write it down.)</p></li><li><p><code>FDs</code>: List obvious dependencies (e.g., product_id ‚Üí name, price).</p></li><li><p><code>1NF</code>: Any arrays/CSV/duplicate groups in a row? Split to rows.</p></li><li><p><code>2NF</code>: With composite keys, does every non-key depend on the whole key?</p></li><li><p><code>3NF</code>: Any non-key depending on another non-key? Move it out.</p></li><li><p><code>Integrity</code>: Add PKs, FKs, UNIQUE, CHECKs.</p></li><li><p><code>Performance</code>: Add indexes that match your most common WHERE/JOIN/ORDER BY.</p></li></ul><p>Normalize for correctness; denormalize deliberately for speed with clear ownership and refresh logic.</p><hr><h2 id=-wrapping-up>üîÑ Wrapping Up</h2><p>Understanding databases isn&rsquo;t just about memorizing SQL queries. It‚Äôs about knowing how data structures (like B-Trees), transaction guarantees (ACID), and design principles (normalization) affect your application‚Äôs performance, reliability, and scalability.</p><p>Whether you&rsquo;re architecting a high-availability service or fine-tuning a reporting dashboard, strong database knowledge will elevate your solutions.</p><hr><p>üöÄ Follow me on <a href=https://norbix.dev>norbix.dev</a> for more insights on Go, Python, AI, system design, and engineering wisdom.</p></div><div class=post-subscribe><style>.subscribe-form{display:flex;gap:.5rem;margin-top:1rem;align-items:center}.subscribe-form input[type=email]{padding:.5rem;border-radius:6px;border:1px solid #ccc;background-color:#1f1f1f;color:#fff}.subscribe-form input[type=submit],.subscribe-form button{padding:.5rem 1rem;border-radius:6px;background-color:#facc15;color:#000;border:none;cursor:pointer;font-weight:700}.subscribe-form input[type=submit]:hover{background-color:#fcd34d}</style><form action=https://buttondown.email/api/emails/embed-subscribe/norbix method=post target=popupwindow onsubmit='window.open("https://buttondown.email/norbix","popupwindow")' class=subscribe-form><input type=email name=email placeholder="Enter your email" required>
<input type=submit value=Subscribe></form><p style=font-size:.875rem;opacity:.6>Powered by Buttondown.</p></div><div class=post-comments><script src=https://giscus.app/client.js data-repo=norbix/norbix.dev data-repo-id=R_kgDOOV_xMQ data-category=Announcements data-category-id=DIC_kwDOOV_xMc4CpF5M data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark data-lang=en crossorigin=anonymous async></script></div><nav class=paginav><a class=prev href=https://norbix.dev/posts/saas-microservices/><span class=title>¬´ Prev</span><br><span>Building SaaS Microservices in Go: REST, gRPC, GraphQL, and WebSocket APIs</span>
</a><a class=next href=https://norbix.dev/posts/movement-patterns-and-logical-thinking/><span class=title>Next ¬ª</span><br><span>Movement Patterns & Logical Thinking in Software Engineering</span></a></nav></article></main></main><footer class=footer><span>&copy; 2025 <a href=https://norbix.dev/>norbix.dev - The log of my journey through code & software systems architecture</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script src=https://platform.linkedin.com/badges/js/profile.js async defer type=text/javascript></script></body></html>